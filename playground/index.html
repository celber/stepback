<html>
    <head>
        <title>StepBack Playground</title>
        <link href="https://fonts.googleapis.com/css?family=Quicksand:300,400&display=swap" rel="stylesheet">
        <script type="application/javascript" src="https://unpkg.com/codeflask/build/codeflask.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.5.11/split.min.js"></script>
        <link href="style.css" rel="stylesheet">
        <link href="runBtn.css" rel="stylesheet">
    </head>
    <body>
        <div class="header">
            <div class='logo'>&nbsp;</div><div class="title">Playground</div>
            <div id="examplesBtn" class="inline">
                <span>Examples&nbsp;&nbsp;▼</span>
                <div class="dropdown">
                    <span>Examples&nbsp;&nbsp;◢</span>
                    <hr/>
                    <a href="#fitlayout">Fit layout</a>
                    <a href="#vsplitlayout">VSplit layout</a>
                </div>
            </div>
        </div>
        <div class='editor'>
                <div id='editorWrapper'>
                        <div id="editorPanelJS" class="editorPanel"></div>
                        <div id="editorPanelCSS" class="editorPanel"></div>
                        <div id="editorActions" class="editorPanel">
                                <div id="runProgress">
                                    <div class="waiting-message">Change code to autorun....</div>
                                    <div class="progress-message">Autorun in progress...</div>
                                    <div class="progress-bar"></div>
                                </div>
                                <button id="runBtn" class="bubbly-button">Run</button>
                        </div>
                </div>
        
                <iframe id="resultPanel">
                    
                </iframe>
        </div>

    </body>
    <script>
        var flaskJS = new CodeFlask('#editorPanelJS', { language: 'js', lineNumbers: true });
        var flaskCSS = new CodeFlask('#editorPanelCSS', { language: 'css', lineNumbers: true });

        var initialCodeJS = 
`var viewport = new Sb.layout.Fit({
    items: [{
            componentType: 'container',
            classList: ['green-bg'],
            items: [{
                componentType: \"zen:button\",
                primary: true,
                text: \"Click Me!\",
                handler: function () {
                    console.log(this);
                }
            }]
        }]
    });
    
viewport.renderTo(Sb.queryOne(\"#app\"));`

var initialCodeCSS = 
`#app {
    height: 40px;
    width: 500px;
}
body {
    background-color: #fafafa;
    margin: 0; 
    padding: 10px;
    padding-top: 30px;
}

.green-bg {
    background-color: #00ff0022;
}

.sb-fit-container {
    background-color: #ff000022;
}`;

        flaskJS.updateCode(initialCodeJS);

        flaskCSS.updateCode(initialCodeCSS);

        document.getElementById('runBtn').onclick = function () {
            var codeJS  = flaskJS.getCode();
            var codeCSS = flaskCSS.getCode();
            var frameDoc = document.getElementById('resultPanel').contentWindow.document;
            frameDoc.open();
            frameDoc.write(`
                <head>
                    <script type=\"application/javascript\" src=\"./sb.js\"> <\/script>
                    <link rel=\"stylesheet\" href=\"./sb.css\"/>
                    <style>
                        ${codeCSS}
                    <\/style>
            <\/head>
            <body>
                <div id=\"app\"><\/div>
            <\/body>
            <script type=\"application/javascript\">
            ${codeJS}
            <\/script>`
            );
            frameDoc.close();
        }
    

        Split(['#editorWrapper', '#resultPanel'], {
            sizes: [45, 55],
            gutterSize: 10
        });

        Split(['#editorPanelJS', '#editorPanelCSS','#editorActions'], {
            sizes: [49, 49, 2],
            direction: 'vertical',
            minSize: 135,
            gutterSize: 10,
        });

        var animateButton = function(e) {
            e.preventDefault;
            //reset animation
            e.target.classList.remove('animate');

            e.target.classList.add('animate');
            setTimeout(function(){
            e.target.classList.remove('animate');
            },700);
        };

        var bubblyButtons = document.getElementsByClassName("bubbly-button");

        for (var i = 0; i < bubblyButtons.length; i++) {
            bubblyButtons[i].addEventListener('click', animateButton, false);
        }

        if(window.location.hash) {
            loadExample(window.location.hash.substring(1,window.location.hash.length))
        }

        window.addEventListener('hashchange', function() {
            loadExample(window.location.hash.substring(1,window.location.hash.length))
        });

        function loadExample(name) {
            console.log(name)
            // TODO load example
        }


        // bind events after one seconds because for some reason flask is firing few events on initialize
        setTimeout(function (){
            flaskJS.onUpdate(runDelay);
            flaskCSS.onUpdate(runDelay);
        },1000);

        var RUN_DELAY = 2000;
        var progressInterval = null;
        function runDelay(code) {
            var progress = 0;
            clearInterval(progressInterval);
            progressInterval = setInterval(function () {
                progress++;
                if (progress > 99) {
                    progress = 0;
                    clearInterval(progressInterval);
                    document.getElementById('runBtn').click();
                }
                document.querySelector('#runProgress .progress-bar').style.width = progress+"%";
            }, RUN_DELAY/100);
        }

    </script>
</html>